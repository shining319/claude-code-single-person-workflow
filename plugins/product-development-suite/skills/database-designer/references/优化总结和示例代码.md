# DrawDB JSON 格式优化总结

## 主要变更

基于真实的 DrawDB JSON 文件分析,以下是关键的格式修正:

### 1. ID 格式变更

**原格式 (错误):**
- 表 ID: 数字递增 (0, 1, 2, ...)
- 字段 ID: 表内数字递增 (0, 1, 2, ...)
- 关系 ID: 数字递增 (0, 1, 2, ...)

**新格式 (正确):**
- 表 ID: **21字符随机字符串** (如 `"_KV5MtPf2m4sI7Inu8pat"`)
- 字段 ID: **21字符随机字符串** (如 `"B8rPRTDtOv9oD2Gp4bhWL"`)
- 关系 ID: **21字符随机字符串** (如 `"vrbZaYZLNo_ESZWqI5KHv"`)
- 索引 ID: **数字递增** (0, 1, 2, ...) - 跨所有表全局递增

### 2. Type 字段格式变更

**原格式 (错误):**
```json
{
  "type": "VARCHAR",
  "size": 100
}
```

**新格式 (正确):**
```json
{
  "type": "VARCHAR(100)"
}
```

- **没有独立的 size 字段**
- 类型定义包含完整信息: `"VARCHAR(100)"`, `"DECIMAL(10,2)"`, `"TINYINT(1)"`

### 3. 索引字段引用变更

**原格式 (错误):**
```json
{
  "fields": [0, 1]  // 使用字段ID数字
}
```

**新格式 (正确):**
```json
{
  "fields": ["email", "username"]  // 使用字段名称字符串
}
```

### 4. 表结构字段顺序

**原顺序 (不推荐):**
```json
{
  "id": "...",
  "name": "...",
  "x": 100,
  "y": 100,
  "fields": [],
  "comment": "...",
  "indices": [],
  "color": "#6360f7"
}
```

**新顺序 (推荐):**
```json
{
  "id": "...",
  "name": "...",
  "comment": "...",
  "color": "#6360f7",
  "fields": [],
  "indices": [],
  "x": 100.0,
  "y": 100.0
}
```

### 5. Relationship 字段顺序

**新顺序 (推荐):**
```json
{
  "name": "",
  "startTableId": "...",
  "endTableId": "...",
  "endFieldId": "...",
  "startFieldId": "...",
  "id": "...",
  "updateConstraint": "No action",
  "deleteConstraint": "No action",
  "cardinality": "many_to_one"
}
```

---

## Python 实现示例

```python
import random
import string
import json

class DrawDBGenerator:
    def __init__(self):
        self.colors = [
            "#6360f7",  # 紫色
            "#bc49c4",  # 粉紫色
            "#ffe159",  # 黄色
            "#89e667",  # 绿色
            "#ff9159",  # 橙色
            "#59d9ff",  # 蓝色
            "#ff5959",  # 红色
            "#a0a0a0"   # 灰色
        ]
        self.index_id_counter = 0
        self.table_map = {}  # 表名 -> {id, fields: {字段名 -> id}}
        
    def generate_id(self):
        """生成21字符随机ID"""
        chars = string.ascii_letters + string.digits + '_-'
        return ''.join(random.choice(chars) for _ in range(21))
    
    def get_coordinates(self, table_index):
        """计算表的坐标"""
        x = (table_index % 3) * 450 + 50
        y = (table_index // 3) * 400 + 50
        return float(x), float(y)
    
    def get_color(self, table_index):
        """获取表的颜色"""
        return self.colors[table_index % len(self.colors)]
    
    def create_field(self, name, field_type, default="", primary=False, 
                     unique=False, not_null=False, increment=False, comment=""):
        """创建字段对象"""
        return {
            "id": self.generate_id(),
            "name": name,
            "type": field_type,  # 完整类型定义,如 "VARCHAR(100)"
            "default": str(default),  # 始终是字符串
            "check": "",
            "primary": primary,
            "unique": unique,
            "notNull": not_null,
            "increment": increment,
            "comment": comment
        }
    
    def create_index(self, name, field_names, unique=False):
        """创建索引对象"""
        index = {
            "id": self.index_id_counter,
            "fields": field_names,  # 字段名称数组,不是ID!
            "name": name,
            "unique": unique
        }
        self.index_id_counter += 1
        return index
    
    def create_table(self, table_index, name, comment, fields, indices=None):
        """创建表对象"""
        table_id = self.generate_id()
        x, y = self.get_coordinates(table_index)
        color = self.get_color(table_index)
        
        # 创建字段并记录ID映射
        field_objects = []
        field_map = {}
        for field_def in fields:
            field_obj = self.create_field(**field_def)
            field_objects.append(field_obj)
            field_map[field_obj["name"]] = field_obj["id"]
        
        # 记录表信息
        self.table_map[name] = {
            "id": table_id,
            "fields": field_map
        }
        
        # 创建索引
        index_objects = []
        if indices:
            for idx_def in indices:
                index_objects.append(self.create_index(**idx_def))
        
        return {
            "id": table_id,
            "name": name,
            "comment": comment,
            "color": color,
            "fields": field_objects,
            "indices": index_objects,
            "x": x,
            "y": y
        }
    
    def create_relationship(self, start_table, start_field, 
                           end_table, end_field, cardinality="many_to_one"):
        """创建关系对象"""
        # 查找表和字段ID
        start_table_id = self.table_map[start_table]["id"]
        start_field_id = self.table_map[start_table]["fields"][start_field]
        end_table_id = self.table_map[end_table]["id"]
        end_field_id = self.table_map[end_table]["fields"][end_field]
        
        return {
            "name": "",
            "startTableId": start_table_id,
            "endTableId": end_table_id,
            "endFieldId": end_field_id,
            "startFieldId": start_field_id,
            "id": self.generate_id(),
            "updateConstraint": "No action",
            "deleteConstraint": "No action",
            "cardinality": cardinality
        }
    
    def generate(self, tables, relationships, title="Database"):
        """生成完整的DrawDB JSON"""
        table_objects = []
        for i, table_def in enumerate(tables):
            table_obj = self.create_table(i, **table_def)
            table_objects.append(table_obj)
        
        relationship_objects = []
        for rel_def in relationships:
            rel_obj = self.create_relationship(**rel_def)
            relationship_objects.append(rel_obj)
        
        return {
            "tables": table_objects,
            "relationships": relationship_objects,
            "notes": [],
            "subjectAreas": [],
            "database": "generic",
            "types": [],
            "title": title
        }


# 使用示例
def example_usage():
    generator = DrawDBGenerator()
    
    # 定义表结构
    tables = [
        {
            "name": "user_info",
            "comment": "用户信息表",
            "fields": [
                {
                    "name": "id",
                    "field_type": "BIGINT",
                    "primary": True,
                    "unique": True,
                    "not_null": True,
                    "increment": True,
                    "comment": "用户ID"
                },
                {
                    "name": "username",
                    "field_type": "VARCHAR(50)",
                    "not_null": True,
                    "comment": "用户名"
                },
                {
                    "name": "email",
                    "field_type": "VARCHAR(100)",
                    "unique": True,
                    "not_null": True,
                    "comment": "邮箱地址"
                },
                {
                    "name": "created_at",
                    "field_type": "DATETIME",
                    "not_null": True,
                    "comment": "创建时间"
                }
            ],
            "indices": [
                {"name": "uk_email", "field_names": ["email"], "unique": True},
                {"name": "idx_username", "field_names": ["username"]}
            ]
        },
        {
            "name": "order_info",
            "comment": "订单信息表",
            "fields": [
                {
                    "name": "id",
                    "field_type": "BIGINT",
                    "primary": True,
                    "unique": True,
                    "not_null": True,
                    "increment": True,
                    "comment": "订单ID"
                },
                {
                    "name": "user_id",
                    "field_type": "BIGINT",
                    "not_null": True,
                    "comment": "用户ID"
                },
                {
                    "name": "order_no",
                    "field_type": "VARCHAR(50)",
                    "unique": True,
                    "not_null": True,
                    "comment": "订单编号"
                },
                {
                    "name": "total_amount",
                    "field_type": "DECIMAL(10,2)",
                    "not_null": True,
                    "default": "0",
                    "comment": "订单总金额"
                }
            ],
            "indices": [
                {"name": "uk_order_no", "field_names": ["order_no"], "unique": True},
                {"name": "idx_user_id", "field_names": ["user_id"]}
            ]
        }
    ]
    
    # 定义关系
    relationships = [
        {
            "start_table": "order_info",
            "start_field": "user_id",
            "end_table": "user_info",
            "end_field": "id",
            "cardinality": "many_to_one"
        }
    ]
    
    # 生成JSON
    result = generator.generate(tables, relationships, "电商系统数据库")
    
    # 输出
    print(json.dumps(result, ensure_ascii=False, indent=2))


if __name__ == "__main__":
    example_usage()
```

---

## 类型转换参考

### SQL 到 DrawDB Type 字段

| SQL 类型 | DrawDB type 值 |
|---------|---------------|
| `BIGINT` | `"BIGINT"` |
| `INT` | `"INT"` |
| `TINYINT` | `"TINYINT"` |
| `TINYINT(1)` | `"TINYINT(1)"` |
| `VARCHAR(50)` | `"VARCHAR(50)"` |
| `TEXT` | `"TEXT"` |
| `LONGTEXT` | `"LONGTEXT"` |
| `DATETIME` | `"DATETIME"` |
| `TIMESTAMP` | `"TIMESTAMP"` |
| `DATE` | `"DATE"` |
| `DECIMAL(10,2)` | `"DECIMAL(10,2)"` |
| `BOOLEAN` | `"BOOLEAN"` |
| `ENUM('A','B')` | `"ENUM(A,B)"` |

### 注意事项

1. **完整类型字符串**: Type 字段必须包含完整的类型定义,包括长度和精度
2. **ENUM 格式**: ENUM 类型不需要引号,直接用逗号分隔值
3. **布尔类型**: 可以用 `BOOLEAN` 或 `TINYINT(1)`
4. **默认值**: 所有默认值都转换为字符串类型

---

## 验证清单

生成 DrawDB JSON 前检查:

- [ ] 所有表ID都是21字符随机字符串
- [ ] 所有字段ID都是21字符随机字符串
- [ ] 所有关系ID都是21字符随机字符串
- [ ] 索引ID使用数字递增(跨所有表)
- [ ] type字段包含完整类型定义(如 `"VARCHAR(100)"`)
- [ ] 没有使用size字段
- [ ] 索引的fields数组使用字段名称字符串
- [ ] default值都是字符串类型
- [ ] 坐标使用浮点数
- [ ] 表对象字段顺序: id, name, comment, color, fields, indices, x, y
- [ ] 关系对象字段顺序正确
- [ ] 所有中文注释正确显示

---

## 常见错误及修复

### 错误1: 使用数字ID
```json
// ❌ 错误
{"id": 0}

// ✅ 正确
{"id": "_KV5MtPf2m4sI7Inu8pat"}
```

### 错误2: 分离type和size
```json
// ❌ 错误
{"type": "VARCHAR", "size": 100}

// ✅ 正确
{"type": "VARCHAR(100)"}
```

### 错误3: 索引使用字段ID
```json
// ❌ 错误
{"fields": [0, 1]}

// ✅ 正确
{"fields": ["email", "username"]}
```

### 错误4: 数字默认值
```json
// ❌ 错误
{"default": 0}

// ✅ 正确
{"default": "0"}
```

### 错误5: 整数坐标
```json
// ❌ 不推荐
{"x": 100, "y": 200}

// ✅ 推荐
{"x": 100.0, "y": 200.0}
```
