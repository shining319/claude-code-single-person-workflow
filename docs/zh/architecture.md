# 架构文档

## 概述

单人工作流市场被设计为 Claude Code 的模块化、可扩展插件系统。本文档解释了架构、设计决策以及组件如何协同工作。

## 系统架构

```
Claude Code CLI
    │
    ├─── 单人工作流市场（根目录）
    │       │
    │       ├─── 独立技能
    │       │     ├─── academic-writing（学术写作）
    │       │     ├─── database-designer（数据库设计器）
    │       │     ├─── product-manager（产品经理）
    │       │     ├─── ui-designer（UI设计师）
    │       │     └─── solution-architect（解决方案架构师）
    │       │
    │       ├─── 技能套件
    │       │     └─── product-development-suite（产品开发套件）
    │       │           （打包所有5个技能）
    │       │
    │       └─── 工作流代理
    │             └─── product-workflow-agents（产品工作流代理）
    │                   ├─── 全栈产品构建者
    │                   ├─── 产品需求分析师
    │                   ├─── 数据库架构规划师
    │                   ├─── UI/UX设计协调员
    │                   ├─── 技术解决方案设计师
    │                   └─── 文档生成器
```

## 核心概念

### 1. 技能（Skills）

**定义：** 技能是 Claude Code 可以调用来执行特定任务的专门能力。

**特征：**
- 单一职责（一个技能，一个目的）
- 通过自然语言触发
- 产生特定的输出格式
- 无状态（每次调用都是独立的）

**实现：**
```
plugins/
  └─── skill-name/
       ├─── skill.md          # 技能提示和说明
       └─── examples/         # 使用示例（可选）
```

### 2. 技能套件（Skill Suites）

**定义：** 为方便起见而捆绑在一起的相关技能集合。

**优势：**
- 一次安装多个技能
- 能力的逻辑分组
- 降低安装复杂性

**实现：**
```
plugins/
  └─── suite-name/
       ├─── skill.md          # 套件元数据
       └─── skills/           # 捆绑的独立技能
            ├─── skill-1/
            ├─── skill-2/
            └─── skill-3/
```

### 3. 工作流代理（Workflow Agents）

**定义：** 编排多个技能和任务以完成复杂工作流的智能代理。

**能力：**
- 多步骤任务协调
- 自动技能选择
- 跨步骤的上下文管理
- 决策制定和规划

**实现：**
```
plugins/
  └─── workflow-agents/
       ├─── agent.md          # 代理配置
       └─── agents/
            ├─── agent-1/
            ├─── agent-2/
            └─── agent-3/
```

## 插件结构

### 最小插件

```
plugin-name/
├─── skill.md              # 必需：技能定义
└─── README.md             # 可选：文档
```

### 完整插件

```
plugin-name/
├─── skill.md              # 技能定义
├─── README.md             # 文档
├─── examples/             # 使用示例
│    ├─── example-1.md
│    └─── example-2.md
├─── templates/            # 输出模板
│    └─── template.md
└─── tests/                # 测试用例
     └─── test-cases.md
```

## 技能定义格式

### 基本结构（skill.md）

```markdown
---
name: skill-name
description: 技能功能的简要描述
triggers:
  - keyword1
  - keyword2
  - phrase pattern
---

# 技能说明

Claude 如何执行此技能的详细说明。

## 输入

预期的输入格式和参数。

## 处理

处理输入的步骤。

## 输出

预期的输出格式和结构。
```

### 示例：数据库设计器

```markdown
---
name: database-designer
description: 完整的数据库架构设计和ER图
triggers:
  - 数据库设计
  - 架构设计
  - ER图
  - 数据模型
---

# 数据库设计器技能

您是数据库设计专家...

[详细说明如下]
```

## 代理架构

### 代理类型

1. **编排代理**
   - 协调多个技能
   - 示例：全栈产品构建者

2. **专家代理**
   - 在某一领域具有深厚专业知识
   - 示例：数据库架构规划师

3. **实用代理**
   - 支持和辅助功能
   - 示例：文档生成器

### 代理决策流程

```
用户请求
    │
    ├─── 代理分析请求
    │       │
    │       ├─── 确定所需技能
    │       ├─── 规划执行顺序
    │       └─── 分配资源
    │
    ├─── 代理执行步骤
    │       │
    │       ├─── 步骤1：激活技能A
    │       ├─── 步骤2：激活技能B
    │       └─── 步骤N：激活技能N
    │
    └─── 代理交付结果
            │
            ├─── 组合输出
            ├─── 验证完整性
            └─── 呈现给用户
```

## 与 Claude Code 集成

### 技能激活

1. **用户输入：** 用户输入自然语言请求
2. **模式匹配：** Claude Code 将请求与技能触发器匹配
3. **技能加载：** 加载相应的 skill.md
4. **上下文注入：** 技能说明被注入到上下文中
5. **执行：** Claude 使用技能说明处理请求
6. **输出：** 格式化并呈现结果

### 上下文管理

```
会话上下文
    │
    ├─── 用户请求历史
    ├─── 活动技能上下文
    ├─── 生成的输出
    └─── 工作流状态（用于代理）
```

## 设计原则

### 1. 模块化

每个技能都是独立的，可以单独安装/卸载。

**优势：**
- 用户只安装需要的内容
- 易于维护和更新
- 清晰的关注点分离

### 2. 可组合性

技能和代理可以组合创建复杂的工作流。

**示例：**
- 产品经理 → 数据库设计器 → UI设计师
- 解决方案架构师 ← 数据库设计器 → UI设计师

### 3. 可发现性

技能根据自然语言触发器自动激活。

**实现：**
- 广泛的触发模式以提高灵活性
- 相关技能的重叠触发器
- 基于对话的上下文激活

### 4. 一致性

所有技能遵循相似的模式以提供可预测的用户体验。

**标准：**
- 一致的输出格式
- 可预测的文件位置
- 统一的文档结构

## 文件输出约定

### 目录结构

```
project-root/
├─── database/
│    ├─── schema-design.md
│    ├─── schema.sql
│    └─── er-diagram.json
├─── design/
│    ├─── ui-specification.md
│    └─── wireframes/
├─── docs/
│    ├─── prd.md
│    ├─── api-documentation.md
│    └─── technical-specs.md
└─── architecture/
     ├─── system-architecture.md
     └─── deployment-plan.md
```

### 文件命名约定

- 使用短横线命名法：`user-authentication-flow.md`
- 包含版本时间戳：`schema-design-2024-01-15.md`
- 使用描述性名称：`e-commerce-database-schema.sql`

## 可扩展性

### 添加新技能

1. 创建插件目录结构
2. 编写包含清晰说明的 skill.md
3. 定义触发模式
4. 记录使用示例
5. 使用各种输入进行测试

### 创建自定义代理

1. 识别工作流模式
2. 映射所需技能
3. 定义决策逻辑
4. 实现协调策略
5. 测试端到端工作流

### 贡献技能

要贡献新技能：

1. Fork 仓库
2. 按照结构指南创建插件
3. 添加全面的文档
4. 包含使用示例
5. 提交拉取请求

## 性能考虑

### Token 效率

- 技能使用简洁、专注的提示
- 避免冗余说明
- 为常见模式使用模板

### 上下文窗口管理

- 仅在需要时加载技能
- 大型说明被适当分块
- 历史上下文被高效管理

### 缓存策略

- 技能定义可缓存
- 生成的输出引用缓存内容
- 模板减少冗余生成

## 安全考虑

### 输入验证

技能应验证：
- 用户输入参数
- 文件路径目标
- 外部资源引用

### 输出净化

生成的输出应：
- 在 SQL 中转义特殊字符
- 验证文件路径
- 净化用户提供的内容

### 安全默认值

- 保守的权限
- 安全的配置示例
- 最佳实践推荐

## 测试策略

### 技能测试

1. **单元测试：** 单个技能激活
2. **集成测试：** 技能组合
3. **回归测试：** 更新间的一致性

### 代理测试

1. **工作流测试：** 完整的代理流程
2. **边缘情况测试：** 不寻常的请求
3. **性能测试：** 大规模操作

## 未来增强

### 计划功能

1. **交互式代理：** 多轮对话
2. **可自定义模板：** 用户定义的输出格式
3. **技能市场：** 社区贡献的技能
4. **版本管理：** 技能版本控制和兼容性

### 潜在集成

1. **外部工具：** 与设计工具、数据库集成
2. **CI/CD 流水线：** 自动文档生成
3. **项目模板：** 初始化项目结构

## 架构故障排除

### 常见问题

**技能未激活：**
- 检查触发模式是否匹配
- 验证 skill.md 格式是否正确
- 确保插件已安装

**代理协调失败：**
- 审查工作流逻辑
- 检查技能依赖关系
- 验证上下文传递

**输出格式问题：**
- 验证模板结构
- 检查文件路径权限
- 验证输出格式化

## 技术规范

### 支持的格式

- **输入：** 自然语言、Markdown、JSON
- **输出：** Markdown、SQL、JSON、DBML、PlantUML
- **文档：** GitHub 风格的 Markdown

### 依赖

- Claude Code CLI v1.0+
- Git（用于安装）
- Node.js（用于某些生成的输出）

### 兼容性

- **操作系统：** Windows、macOS、Linux
- **Claude 模型：** 所有当前模型
- **Claude Code 版本：** 最新稳定版本

## 开发者最佳实践

### 技能开发

1. 从清晰的用例开始
2. 定义狭窄的范围
3. 编写全面的说明
4. 包含多样化的示例
5. 使用真实场景进行测试

### 代理开发

1. 映射完整的工作流
2. 识别技能依赖关系
3. 处理边缘情况
4. 提供清晰的进度反馈
5. 验证最终输出

### 文档

1. 为初学者编写
2. 包含实际示例
3. 展示常见模式
4. 解释决策理由
5. 保持更新

## 结论

单人工作流市场为构建专门的 Claude Code 能力提供了灵活、可扩展的架构。通过遵循模块化设计原则和清晰的约定，它使独立开发者能够访问专业级工具，进行完整的产品开发。

有关实施细节，请参阅[用户指南](user-guide.md)。有关安装说明，请参阅[安装指南](installation.md)。
